<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--[if lt IE 9]>
                <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
        <![endif]-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <!-- <link rel="stylesheet" type="text/css" href="template.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <!-- <script type='text/javascript' src='menu/js/jquery.cookie.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.hoverIntent.minified.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.dcjqaccordion.2.7.min.js'></script> -->

    <!-- <link href="menu/css/skins/blue.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/graphite.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/grey.css" rel="stylesheet" type="text/css" /> -->
  
    <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
        
  
    <!-- <script src="script.js"></script> -->
  
    <!-- <script src="jquery.sticky-kit.js "></script> -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/ryangrose/easy-pandoc-templates@948e28e5/css/elegant_bootstrap.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    <meta name="generator" content="pandoc" />
  <title>sPop2: a dynamically-structured matrix population model</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">sPop2: a dynamically-structured matrix population model</span>
        <ul class="nav pull-right doc-info">
                            </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#population.jl">Population.jl</a>
        <ul>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#using-the-library">Using the library</a></li>
        <li><a href="#references">References</a></li>
        </ul></li>
        <li><a href="#usage-examples">Usage examples</a>
        <ul>
        <li><a href="#a-deterministic-ode-model-of-larva-development">A deterministic ODE model of larva development</a></li>
        <li><a href="#a-deterministic-population-with-erlang-distributed-accumulative-development">A deterministic population with Erlang-distributed accumulative development</a></li>
        <li><a href="#accounting-for-stochasticity">Accounting for stochasticity</a></li>
        <li><a href="#distributions-and-assumptions">Distributions and assumptions</a></li>
        <li><a href="#combining-multiple-processes">Combining multiple processes</a></li>
        <li><a href="#gonotrophic-cycle-with-a-negative-impact-of-ovipositioning">Gonotrophic cycle with a negative impact of ovipositioning</a></li>
        </ul></li>
        <li><a href="#case-studies">Case studies</a></li>
        </ul>

        </div>
      </div>
            <div class="span9">
      <h1 id="population.jl">Population.jl</h1>
<p><img src="figures/logo_sPop2.jpg" title="Climate impacts on vector-borne diseases" /></p>
<p>This is the standalone Julia library of the dynamically-structured matrix population model sPop2. This version implements both age-dependent and accumulative processes.</p>
<h2 id="installation">Installation</h2>
<p>Just type this in Julia:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Pkg</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    Pkg.add(<span class="st">&quot;Population&quot;</span>)</span></code></pre></div>
<p>Alternatively, one could clone or download and extract the development version from this GitHub repository, and use the package as follows.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Pkg</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    Pkg.add(<span class="st">&quot;Absolute path to the Population.jl directory&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Population</span></code></pre></div>
<h2 id="using-the-library">Using the library</h2>
<p>The following creates a pseudo-structured population with 10 individuals and iterates it one step with 0 mortality and an Erlang-distributed development time of <span class="math inline">20 ± 5</span> steps.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>    pop <span class="op">=</span> sPop2(PopDataSto())</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    AddProcess(pop<span class="op">,</span> AccErlang())</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    AddPop(pop<span class="op">,</span> <span class="fl">10</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    pr <span class="op">=</span> (devmn<span class="op">=</span><span class="fl">20.0</span><span class="op">,</span> devsd<span class="op">=</span><span class="fl">5.0</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    size<span class="op">,</span> completed<span class="op">,</span> poptabledone <span class="op">=</span> StepPop(pop<span class="op">,</span> pr)</span></code></pre></div>
<p>See section <a href="#usage-examples">Usage examples</a> for further examples.</p>
<h2 id="references">References</h2>
<ul>
<li>Erguler, K., Mendel, J., Petrić, D.V. et al. A dynamically structured matrix population model for insect life histories observed under variable environmental conditions. Sci Rep 12, 11587 (2022). <a href="https://doi.org/10.1038/s41598-022-15806-2">link</a></li>
<li>Erguler K. sPop: Age-structured discrete-time population dynamics model in C, Python, and R [version 3; peer review: 2 approved]. F1000Research 2020, 7:1220. <a href="https://doi.org/10.12688/f1000research.15824.3">link</a></li>
</ul>
<h1 id="usage-examples">Usage examples</h1>
<p>Let’s begin with a canonical example. Arguably, the straightforward way to model insect development is to use an ordinary differential equations system with exponentially distributed transition times.</p>
<h2 id="a-deterministic-ode-model-of-larva-development">A deterministic ODE model of larva development</h2>
<p>Let’s assume that experimental observations of larva development yielded a round figure of 20 days as average development time. This is usually translated to the differential equations reals as an instantaneous rate of <span class="math inline"><em>α</em> = 1/20</span>.</p>
<!---
    using Plots
    using DifferentialEquations

    function develop!(du,u,p,t)
        du[1] = -(1.0/20.0)*u[1]
        du[2] = (1.0/20.0)*u[1]
    end

    u0 = [100.0; 0.0;]
    tspan = (0.0, 100.0)
    prob = ODEProblem(develop!,u0,tspan)
    sol = solve(prob)

    plot(sol,vars=(0,1),lw=4, label="Larva")
-->
<div class="sourceCode" id="cb4"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> DifferentialEquations</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> develop<span class="op">!</span>(du<span class="op">,</span>u<span class="op">,</span>p<span class="op">,</span>t)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        du[<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span>(<span class="fl">1.0</span><span class="op">/</span><span class="fl">20.0</span>)<span class="op">*</span>u[<span class="fl">1</span>]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        du[<span class="fl">2</span>] <span class="op">=</span> (<span class="fl">1.0</span><span class="op">/</span><span class="fl">20.0</span>)<span class="op">*</span>u[<span class="fl">1</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    u0 <span class="op">=</span> [<span class="fl">100.0</span><span class="op">;</span> <span class="fl">0.0</span><span class="op">;</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    tspan <span class="op">=</span> (<span class="fl">0.0</span><span class="op">,</span> <span class="fl">100.0</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> ODEProblem(develop<span class="op">!,</span>u0<span class="op">,</span>tspan)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    sol <span class="op">=</span> solve(prob)</span></code></pre></div>
<figure>
<img src="figures/det_ode.png" title="Deterministic - ODE" alt="Larva development modelled using an ODE" /><figcaption aria-hidden="true">Larva development modelled using an ODE</figcaption>
</figure>
<p>Expectedly, this implies that larvae begin developing by the time they emerge from eggs, and keep producing pupae at the same constant rate until a negligible number of larvae is left.</p>
<h2 id="a-deterministic-population-with-erlang-distributed-accumulative-development">A deterministic population with Erlang-distributed accumulative development</h2>
<p>An alternative representation with a structured population can be constructed. For this, we need to know not the rate of pupa production, but the average duration of the larva stage and its variation. Let’s assume that stage duration follows a <a href="https://en.wikipedia.org/wiki/Gamma_distribution">gamma</a> distribution (<a href="https://en.wikipedia.org/wiki/Erlang_distribution">Erlang</a> to be precise), which implies that all individuals race to develop out of the larva stage, while some are faster and even more of them are slower.</p>
<!---
    using Plots
    using Distributions

    pop = sPop2(PopDataDet())

    AddProcess(pop, AccErlang())

    pr1 = (devmn=20.0, devsd=5.0)

    AddPop(pop, 10.0)
    out = [0 10.0 0.0]
    xr = 0:50
    for n in xr[2:end]
        ret = StepPop(pop, pr1)
        out = vcat(out, [n ret[1] ret[2]])
    end

    k, theta, stay = pop.hazards[1].pars(pr1)

    plot(out[:,1], out[:,2], line = :scatter, c="black", ms=8, label="Deterministic")
    plot!(xr, 10.0*(1.0 .- cdf(Gamma(k,theta),xr)), c="gray", lw=4, label="Expected")
-->
<div class="sourceCode" id="cb5"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>    pop <span class="op">=</span> sPop2(PopDataDet())</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    AddProcess(pop<span class="op">,</span> AccErlang())</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    AddPop(pop<span class="op">,</span> <span class="fl">10.0</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> [<span class="fl">0</span> <span class="fl">10.0</span> <span class="fl">0.0</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> n <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        pr1 <span class="op">=</span> (devmn<span class="op">=</span><span class="fl">20.0</span><span class="op">,</span> devsd<span class="op">=</span><span class="fl">5.0</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> StepPop(pop<span class="op">,</span> pr1)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> vcat(out<span class="op">,</span> [n ret[<span class="fl">1</span>] ret[<span class="fl">2</span>]])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span></code></pre></div>
<figure>
<img src="figures/det_erlang.png" title="Deterministic - Erlang-distributed" alt="Erlang-distributed duration of larva development" /><figcaption aria-hidden="true">Erlang-distributed duration of larva development</figcaption>
</figure>
<h2 id="accounting-for-stochasticity">Accounting for stochasticity</h2>
<p>With a simple modification, we can simulate how the dynamics vary when each individual is given a daily chance of completing its development based on the Erlang-distributed development time assumption.</p>
<!---
plot!(outst[:,1], outst[:,2], line = :scatter, c="blue", ms=8, label="Stochastic")
-->
<div class="sourceCode" id="cb6"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    pop <span class="op">=</span> sPop2(PopDataSto())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    AddProcess(pop<span class="op">,</span> AccErlang())</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    AddPop(pop<span class="op">,</span> <span class="fl">10</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    outst <span class="op">=</span> [<span class="fl">0</span> <span class="fl">10</span> <span class="fl">0.0</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> n <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        pr1 <span class="op">=</span> (devmn<span class="op">=</span><span class="fl">20.0</span><span class="op">,</span> devsd<span class="op">=</span><span class="fl">5.0</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> StepPop(pop<span class="op">,</span> pr1)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        outst <span class="op">=</span> vcat(outst<span class="op">,</span> [n ret[<span class="fl">1</span>] ret[<span class="fl">2</span>]])</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span></code></pre></div>
<figure>
<img src="figures/sto_erlang.png" title="Stochastic - Erlang-distributed" alt="Erlang-distributed duration of larva development" /><figcaption aria-hidden="true">Erlang-distributed duration of larva development</figcaption>
</figure>
<h2 id="distributions-and-assumptions">Distributions and assumptions</h2>
<p>The sPop2 framework allows for <a href="https://doi.org/10.12688/f1000research.15824.3">age-dependent</a> and <a href="https://doi.org/10.1038/s41598-022-15806-2">accumulative</a> development times.</p>
<!---
N = 10.0
mu = 20.0
mu2 = 20.0
sd = 10.0

xr = 0:50

function simDet(hazard::HazTypes)
    pop = sPop2(PopDataDet())
    AddProcess(pop, hazard)
    AddPop(pop, N)
    retd = [0 N 0.0]
    for n in xr[2:end]
        pr1 = typeof(hazard) <: AgeConst ? (prob=(mu != mu2 && n > 20) ? 1.0/mu2 : 1.0/mu,) : (devmn=(mu != mu2 && n > 20) ? mu2 : mu, devsd=sd)
        ret = StepPop(pop, pr1)
        retd = vcat(retd, [n ret[1] ret[2]])
    end
    return retd
end

function simStoch(hazard::HazTypes)
    pop = sPop2(PopDataSto())
    AddProcess(pop, hazard)
    rets = []
    for r in 1:1000
        AddPop(pop, Int64(N))
        ret = [Int64(N)]
        for n in xr[2:end]
            pr1 = typeof(hazard) <: AgeConst ? (prob=(mu != mu2 && n > 20) ? 1.0/mu2 : 1.0/mu,) : (devmn=(mu != mu2 && n > 20) ? mu2 : mu, devsd=sd)
            sz = StepPop(pop, pr1)
            push!(ret, sz[1])
        end
        if rets == []
            rets = ret
        else
            rets = cat(rets,ret,dims=2)
        end
        EmptyPop(pop)
    end
    res = []
    for r in 1:size(rets)[1]
        p = quantile(rets[r,:],[0.05,0.5,0.95])
        if res == []
            res = p
        else
            res = hcat(res, p)
        end
    end
    return hcat(xr,transpose(res))
end

hazards = ["AccErlang", "AccPascal", "AccFixed", "AgeFixed", "AgeConst", "AgeGamma", "AgeNbinom"]
for hazard in hazards
    if hazard == "AccErlang"
        hz = AccErlang()
        pr1 = (devmn=mu,devsd=sd)
    elseif hazard == "AccPascal"
        hz = AccPascal()
        pr1 = (devmn=mu,devsd=sd)
    elseif hazard == "AccFixed"
        hz = AccFixed()
        pr1 = (devmn=mu,devsd=sd)
    elseif hazard == "AgeFixed"
        hz = AgeFixed()
        pr1 = (devmn=mu,devsd=sd)
    elseif hazard == "AgeConst"
        hz = AgeConst()
        pr1 = (prob=1.0/mu,)
    elseif hazard == "AgeGamma"
        hz = AgeGamma()
        pr1 = (devmn=mu,devsd=sd)
    elseif hazard == "AgeNbinom"
        hz = AgeNbinom()
        pr1 = (devmn=mu,devsd=sd)
    end
    out_det = simDet(hz)
    out_sto = simStoch(hz)
    k, theta, stay = hz.pars(pr1)
    plt = plot(out_sto[:,1], out_sto[:,4], fillrange = out_sto[:,2], title=hazard, c="#9ecae1", label="Stoch. (90% range)")
    plot!(out_sto[:,1], out_sto[:,3], lw=4, c="#3182bd", label="Stoch. (median)")
    plot!(out_det[:,1], out_det[:,2], line = :scatter, c="black", ms=8, label="Deterministic")
    plot!(out_det[:,1], cumsum(out_det[:,3]), c="black", lw=4, label="Completed (det.)")
    if hazard in ["AccErlang" "AgeGamma"]
        plot!(xr, N*(1.0 .- cdf(Gamma(k,theta),xr)), line= :scatter, c="gray", ms=6, label="Expected")
    elseif hazard in ["AccPascal" "AgeNbinom"]
        plot!(xr, N*(1.0 .- cdf(NegativeBinomial(k,theta),xr .- 1)), line= :scatter, c="gray", ms=6, label="Expected")
    elseif hazard in ["AGE_CONST"]
        plot!(xr, [N*(1.0 .- cdf(Geometric(theta),x-1)) for x in xr], line= :scatter, c="gray", ms=6, label="Expected")
    end
    xlims!(0,50)

    savefig("docs/figures/distr_$(hazard).png")
end
-->
<table style="width:100%;">
<colgroup>
<col style="width: 28%" />
<col style="width: 42%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Process</th>
<th style="text-align: center;">Parameters</th>
<th style="text-align: right;">Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AccErlang</td>
<td style="text-align: center;">devmn, devsd</td>
<td style="text-align: right;">Erlang-distributed accumulative process</td>
</tr>
<tr class="even">
<td style="text-align: left;">AccPascal</td>
<td style="text-align: center;">devmn, devsd</td>
<td style="text-align: right;">Pascal-distributed accumulative process</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AccFixed</td>
<td style="text-align: center;">devmn</td>
<td style="text-align: right;">Fixed-duration accumulative process</td>
</tr>
<tr class="even">
<td style="text-align: left;">AgeFixed</td>
<td style="text-align: center;">devmn</td>
<td style="text-align: right;">Pascal-distributed age-dependent process</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AgeConst</td>
<td style="text-align: center;">prob</td>
<td style="text-align: right;">Constant-rate age-dependent process</td>
</tr>
<tr class="even">
<td style="text-align: left;">AgeGamma</td>
<td style="text-align: center;">devmn, devsd</td>
<td style="text-align: right;">Gamma-distributed age-dependent process</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AgeNbinom</td>
<td style="text-align: center;">devmn, devsd</td>
<td style="text-align: right;">Negative binomial-distributed age-dependent process</td>
</tr>
<tr class="even">
<td style="text-align: left;">AgeCustom</td>
<td style="text-align: center;">User-defined hazard function, Stepper</td>
<td style="text-align: right;">Age-dependent or accumulative stepping with a user-defined hazard function</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Age-dependent</th>
<th style="text-align: right;">Accumulative</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><img src="figures/distr_AgeGamma.png" /></td>
<td style="text-align: right;"><img src="figures/distr_AccErlang.png" /></td>
</tr>
<tr class="even">
<td style="text-align: left;"><img src="figures/distr_AgeNbinom.png" /></td>
<td style="text-align: right;"><img src="figures/distr_AccPascal.png" /></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><img src="figures/distr_AgeFixed.png" /></td>
<td style="text-align: right;"><img src="figures/distr_AccFixed.png" /></td>
</tr>
<tr class="even">
<td style="text-align: left;"><img src="figures/distr_AgeConst.png" /></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
<h2 id="combining-multiple-processes">Combining multiple processes</h2>
<p>Multiple processes can be added to an <em>sPop2</em> to represent more complex dynamics. For instance, we can represent survival with a daily constant rate and development with an Erlang-distributed accumulative process. The processes are executed in the order they are added to the <em>sPop2</em>.</p>
<!---
a = sPop2(PopDataDet())
AddProcess(a, AgeConst(), AccErlang())
AddPop(a,100.0)
ret = [0 GetPop(a) 0.0 0.0]
for i in 0:100
    pr1 = (prob=1.0/60.0,)
    pr2 = (devmn=30.0, devsd=5.0)
    out = StepPop(a, pr1, pr2)
    ret = vcat(ret, [i+1 out[1] out[2][1] out[2][2]])
end

xr = 0:100
plot(ret[:,1],ret[:,2],lw=4,label="Developing")
plot!(ret[:,1],cumsum(ret[:,3]),lw=4,label="Dead")
plot!(ret[:,1],cumsum(ret[:,4]),lw=4,label="Developed")
plot!(xr,[100.0*(1 .- cdf(Geometric(1.0/60.0),x-1)) for x in xr], lw=2, label="Geometric dist.")
-->
<div class="sourceCode" id="cb7"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> sPop2(PopDataDet())</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>AddProcess(a<span class="op">,</span> AgeConst()<span class="op">,</span> AccErlang())</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>AddPop(a<span class="op">,</span> <span class="fl">100.0</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ret <span class="op">=</span> [<span class="fl">0</span> GetPop(a) <span class="fl">0.0</span> <span class="fl">0.0</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> i <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    pr1 <span class="op">=</span> (prob<span class="op">=</span><span class="fl">1.0</span><span class="op">/</span><span class="fl">60.0</span><span class="op">,</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    pr2 <span class="op">=</span> (devmn<span class="op">=</span><span class="fl">30.0</span><span class="op">,</span> devsd<span class="op">=</span><span class="fl">5.0</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> StepPop(a<span class="op">,</span> pr1<span class="op">,</span> pr2)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> vcat(ret<span class="op">,</span> [i<span class="op">+</span><span class="fl">1</span> out[<span class="fl">1</span>] out[<span class="fl">2</span>][<span class="fl">1</span>] out[<span class="fl">2</span>][<span class="fl">2</span>]])</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>The above instruction represent a life stage with <span class="math inline">0.017</span> daily mortality and <span class="math inline">30 ± 5</span> days of development time.</p>
<figure>
<img src="figures/multiple_mortality_development.png" alt="Mortality and development" /><figcaption aria-hidden="true">Mortality and development</figcaption>
</figure>
<h2 id="gonotrophic-cycle-with-a-negative-impact-of-ovipositioning">Gonotrophic cycle with a negative impact of ovipositioning</h2>
<p>In this section, we will attempt to reproduce <a href="https://f1000research.com/articles/7-1220#f1">Figure 1</a> in the original age-dependent <a href="https://doi.org/10.12688/f1000research.15824.3">sPop</a> model. We will represent an adult female mosquito with a lifetime of <span class="math inline">20 ± 2</span> days. The female enters a cyclic process of obtaining bloodmeal and egg development, which takes about <span class="math inline">2</span> days. However, at the end of each ovipositioning, her expected lifetime decreases by <span class="math inline">2</span> days. I assure you that the actual physiology is far more complicated than this!</p>
<p>In order to represent the lifetime of this female mosquito, we will employ <span class="math inline">3</span> processes:</p>
<ul>
<li>A custom age- and ovipositioning-dependent mortality process</li>
<li>An age-dependent gamma-distributed egg development process</li>
<li>A dummy process to count the number of ovipositioning events</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Declare an sPop2 population with deterministic dynamics</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> sPop2(PopDataDet())</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define three processes in this order: Mortality, Gonotropic cycle, Ovipositioning</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    AddProcess(a<span class="op">,</span> AgeCustom(custom<span class="op">,</span> AgeStepper)<span class="op">,</span> AgeGamma()<span class="op">,</span> AgeDummy())</span></code></pre></div>
<p>The <span class="math inline">3<sup><em>r</em><em>d</em></sup></span> process is a dummy (<em>AgeDummy</em>), which does not affect the population or even does not posess a time counter. The <span class="math inline">2<sup><em>n</em><em>d</em></sup></span> process is the regular age-dependent gamma-distributed development process (<em>AgeGamma</em>).</p>
<p>The mortality process, on the other hand, is defined with a <em>custom</em> function and uses the <em>AgeStepper</em>. We included this stepper in process declaration, because we require that the status indicator be an age counter, <em>i.e.</em> the number of steps the <em>sPop2</em> is iterated is kept in the status indicator (see <em>qkey</em> below). We declare the <em>custom</em> function as the following.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> custom(heval<span class="op">::</span><span class="dt">Function</span><span class="op">,</span> d<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> q<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> k<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> theta<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> qkey<span class="op">::</span><span class="dt">Tuple</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    devmn <span class="op">=</span> <span class="fl">480.0</span> <span class="op">-</span> (qkey[<span class="fl">3</span>] <span class="op">&gt;</span> <span class="fl">4</span> ? <span class="fl">240.0</span> <span class="op">:</span> <span class="fl">48.0</span> <span class="op">*</span> qkey[<span class="fl">3</span>])</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    devsd <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> devmn</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    pr <span class="op">=</span> (devmn<span class="op">=</span>devmn<span class="op">,</span> devsd<span class="op">=</span>devsd)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    k<span class="op">,</span> theta<span class="op">,</span> stay <span class="op">=</span> sPop2.age_gamma_pars(pr)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> sPop2.age_hazard_calc(sPop2.age_gamma_haz<span class="op">,</span> <span class="fl">0</span><span class="op">,</span> qkey[<span class="fl">1</span>]<span class="op">,</span> k<span class="op">,</span> theta<span class="op">,</span> qkey)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>With this function, we override an internal mechanism used by all other processes to calculate the probability of exit (need this be due to mortality, development, or something else) from the <em>sPop2</em> population. This generic functional form takes the following parameters.</p>
<ul>
<li><em>heval</em> is a function to calculate the cumulative probability density of an exit event. It may use some of the other parameters to do so.</li>
<li><em>d</em> refers to the number of days (more correctly time steps) elapsed in <em>sPop2</em>.</li>
<li><em>q</em> refers to the fraction of development (used in accumulative processes).</li>
<li><em>k</em> and <em>theta</em> are the parameters of the stage duration (development time) distribution.</li>
<li><em>qkey</em> is a tuple of status indicators (age for age-dependent and development fraction for accumulative processes)</li>
</ul>
<p>Of all these, we use the status indicators to calculate the mean and standard deviation of mortality based on the third (<em>dummy</em>) process.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    devmn <span class="op">=</span> <span class="fl">480.0</span> <span class="op">-</span> (qkey[<span class="fl">3</span>] <span class="op">&gt;</span> <span class="fl">4</span> ? <span class="fl">240.0</span> <span class="op">:</span> <span class="fl">48.0</span> <span class="op">*</span> qkey[<span class="fl">3</span>]) <span class="co"># qkey[3]: Ovipositioning</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    devsd <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> devmn</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    pr <span class="op">=</span> (devmn<span class="op">=</span>devmn<span class="op">,</span> devsd<span class="op">=</span>devsd)</span></code></pre></div>
<p>Then, we calculate the parameters of the corresponding gamma distribution using the internal function</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    k<span class="op">,</span> theta<span class="op">,</span> stay <span class="op">=</span> sPop2.age_gamma_pars(pr)</span></code></pre></div>
<p>and, with these, we calculate the cumulative probability of daily mortality</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    sPop2.age_hazard_calc(sPop2.age_gamma_haz<span class="op">,</span> <span class="fl">0</span><span class="op">,</span> qkey[<span class="fl">1</span>]<span class="op">,</span> k<span class="op">,</span> theta<span class="op">,</span> qkey) <span class="co"># qkey[1]: Mortality</span></span></code></pre></div>
<p>Overall, the script to model the dynamics is given below.</p>
<!---
function custom(heval::Function, d::Number, q::Number, k::Number, theta::Number, qkey::Tuple)
    devmn = 480.0 - (qkey[3] > 4 ? 240.0 : 48.0 * qkey[3])
    devsd = 0.1 * devmn
    pr = (devmn=devmn, devsd=devsd)
    k, theta, stay = sPop2.age_gamma_pars(pr)
    return sPop2.age_hazard_calc(sPop2.age_gamma_haz, 0, qkey[1], k, theta, qkey)
end

function SimDet()
    a = sPop2(PopDataDet())
    # Mortality, Gonotropic cycle, Ovipositioning
    AddProcess(a, AgeCustom(custom,AgeStepper), AgeGamma(), AgeDummy())
    AddPop(a,1000.0)
    ret = [0 0.0]
    for i in 0:480
        pr1 = NamedTuple{}()
        pr2 = (devmn=50.0, devsd=10.0)
        out = StepPop(a, pr1, pr2, pr1)
        for (q,n) in out[3][2]
            AddPop(a, n, q.key[1], 0, q.key[3]+one(q.key[3]))
        end
        ret = vcat(ret, [i+1 out[2][2]])
    end
    return ret
end

retd = SimDet()

plot(retd[:,1]/24.0,retd[:,2], lw=2, label="Daily egg laying")
-->
<div class="sourceCode" id="cb13"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> custom(heval<span class="op">::</span><span class="dt">Function</span><span class="op">,</span> d<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> q<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> k<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> theta<span class="op">::</span><span class="dt">Number</span><span class="op">,</span> qkey<span class="op">::</span><span class="dt">Tuple</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>        devmn <span class="op">=</span> <span class="fl">480.0</span> <span class="op">-</span> (qkey[<span class="fl">3</span>] <span class="op">&gt;</span> <span class="fl">4</span> ? <span class="fl">240.0</span> <span class="op">:</span> <span class="fl">48.0</span> <span class="op">*</span> qkey[<span class="fl">3</span>])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        devsd <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> devmn</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        pr <span class="op">=</span> (devmn<span class="op">=</span>devmn<span class="op">,</span> devsd<span class="op">=</span>devsd)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        k<span class="op">,</span> theta<span class="op">,</span> stay <span class="op">=</span> sPop2.age_gamma_pars(pr)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> sPop2.age_hazard_calc(sPop2.age_gamma_haz<span class="op">,</span> <span class="fl">0</span><span class="op">,</span> qkey[<span class="fl">1</span>]<span class="op">,</span> k<span class="op">,</span> theta<span class="op">,</span> qkey)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> sPop2(PopDataDet())</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mortality, Gonotropic cycle, Ovipositioning</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    AddProcess(a<span class="op">,</span> AgeCustom(custom<span class="op">,</span> AgeStepper)<span class="op">,</span> AgeGamma()<span class="op">,</span> AgeDummy())</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    AddPop(a<span class="op">,</span><span class="fl">1000.0</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> [<span class="fl">0</span> <span class="fl">0.0</span>]</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> i <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">480</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        pr1 <span class="op">=</span> <span class="dt">NamedTuple</span>{}()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        pr2 <span class="op">=</span> (devmn<span class="op">=</span><span class="fl">50.0</span><span class="op">,</span> devsd<span class="op">=</span><span class="fl">10.0</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> StepPop(a<span class="op">,</span> pr1<span class="op">,</span> pr2<span class="op">,</span> pr1)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> (q<span class="op">,</span>n) <span class="kw">in</span> out[<span class="fl">3</span>][<span class="fl">2</span>]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Please note that this step is essential!</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            AddPop(a<span class="op">,</span> n<span class="op">,</span> q.key[<span class="fl">1</span>]<span class="op">,</span> <span class="fl">0</span><span class="op">,</span> q.key[<span class="fl">3</span>]<span class="op">+</span>one(q.key[<span class="fl">3</span>]))</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> vcat(ret<span class="op">,</span> [i<span class="op">+</span><span class="fl">1</span> out[<span class="fl">2</span>][<span class="fl">2</span>]])</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ret</span></code></pre></div>
<p>At each step, <em>StepPop</em> returns the following tuple</p>
<ul>
<li>Current size of the population.</li>
<li>Number of individuals completing each process in the given order.</li>
<li>An array of (status indicators - number of individuals) pairs for each process.</li>
</ul>
<p>The script adds all individuals completing a gonotrophic cycle (<em>out[3][2]</em>) back to the population one by one. While doing so, their status indicators are updated manually.</p>
<ul>
<li><em>n</em> individuals are added</li>
<li>Mortality indicator is left unchanged (<em>q.key[1]</em>)</li>
<li>Egg development indicator is reset</li>
<li>Ovipositioning indicator is incremented (<em>q.key[3] + one(q.key[3])</em>)</li>
</ul>
<figure>
<img src="figures/gonotrophic_cycle.png" alt="Mortality, development, and ovipositioning" /><figcaption aria-hidden="true">Mortality, development, and ovipositioning</figcaption>
</figure>
<h1 id="case-studies">Case studies</h1>
<p>## Nicholson's blowflies</p>
<p>Contributed by Sean L. Wu <a href="https://github.com/slwu89">@slwu89</a>.</p>
<p>Nicholson’s blowflies are a classic example of a time-delayed stage-structured population model, and was presented as a case study in the <a href="https://f1000research.com/articles/7-1220">sPop paper</a>. We reproduce that example here using Population.jl.</p>
<p>The model comprises five distinct life-stages and exhibits stable quasi-cyclic oscillations. Although the model was originally constructed using delay differential equations, Population.jl adheres well to the observed dynamics despite the discrete time step. We demonstrate both deterministic and stochastic versions of the basic dynamical model.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Population</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Plots</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Distributions</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> Statistics</span></code></pre></div>
<p>First we define parameters of the model.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define daily propensity of death</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    death <span class="op">=</span> [<span class="fl">0.07</span><span class="op">,</span> <span class="fl">0.004</span><span class="op">,</span> <span class="fl">0.003</span><span class="op">,</span> <span class="fl">0.0025</span><span class="op">,</span> <span class="fl">0.27</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the expected duration of development (in days)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    develop <span class="op">=</span> [<span class="fl">0.6</span><span class="op">,</span> <span class="fl">5.0</span><span class="op">,</span> <span class="fl">5.9</span><span class="op">,</span> <span class="fl">4.1</span><span class="op">,</span> <span class="cn">Inf</span>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the rest of the parameters</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    A0 <span class="op">=</span> <span class="fl">600.0</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> <span class="fl">8.5</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    tau <span class="op">=</span> <span class="fl">24</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tau is a scaling factor to extend from daily to hourly iterations for more accurracy</span></span></code></pre></div>
<p>Next we define a function to run the simulation for 300 days, in either stochastic or deterministic mode. The 5 life stages are stored in the vector <code>vec</code>. Each life stage has an <code>AgeConst</code> process for simulating mortality, which is independent of age in the blowflies model. It also has an <code>AgeFixed</code> process to simulate maturation, which has a deterministic (fixed) distribution in the blowflies model. Therefore variation in the stochastic version arises from the mortality process and egg laying, which is assumed to be drawn from a Poisson distribution centered on the deterministic mean.</p>
<p>On each day we calculate the terms required for the mortality and development processes (<code>pr1</code> and <code>pr2</code>). Then we use <code>StepPop</code> to iterate the population for one day, and we store the output containing the total population size, dictionary of individuals completing development, and dictionary of all developing individuals for that stage in the vector <code>out</code>. Then we pass individuals who have completed development to the next stage life stage. Finally we compute the number of eggs produced by adults and add them to the egg stage.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this function is a wrapper routine to simulate a deterministic or a stochastic time series</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> sim_blowfly(stoch)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> zeros(<span class="fl">300</span><span class="op">*</span>tau<span class="op">+</span><span class="fl">1</span><span class="op">,</span> <span class="fl">5</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># initiate 5 stages of the population and store them in a vector</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        vec <span class="op">=</span> [stoch ? sPop2(PopDataSto()) <span class="op">:</span> sPop2(PopDataDet()) <span class="kw">for</span> n <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        [AddProcess(v<span class="op">,</span> AgeConst()<span class="op">,</span> AgeFixed()) <span class="kw">for</span> v <span class="kw">in</span> vec]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add individuals to the initial stage (the egg stage)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        AddPop(vec[<span class="fl">1</span>]<span class="op">,</span> stoch ? <span class="fl">500</span> <span class="op">:</span> <span class="fl">500.0</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># record the initial conditions</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        output[<span class="fl">1</span><span class="op">,</span> <span class="op">:</span>] <span class="op">=</span> [GetPop(v) <span class="kw">for</span> v <span class="kw">in</span> vec]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># vector to store the output each day</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> <span class="dt">Vector</span>{<span class="dt">Any</span>}(<span class="cn">nothing</span><span class="op">,</span> length(vec))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># iterate for 300 days</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> n <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">300</span><span class="op">*</span>tau        </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># for each stage, repeat the following</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">for</span> m <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>length(vec)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># iterate the stage for one time unit</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                pr1 <span class="op">=</span> (prob <span class="op">=</span> death[m]<span class="op">/</span>tau<span class="op">,</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                pr2 <span class="op">=</span> (devmn <span class="op">=</span> develop[m]<span class="op">*</span>tau<span class="op">,</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                out[m] <span class="op">=</span> StepPop(vec[m]<span class="op">,</span> pr1<span class="op">,</span> pr2)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>                <span class="co"># and pass on to the next stage (if not the adult stage)</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> m <span class="op">&gt;</span> one(m)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">for</span> (q<span class="op">,</span>s) <span class="kw">in</span> out[m<span class="op">-</span><span class="fl">1</span>][<span class="fl">3</span>][<span class="fl">2</span>]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                        AddPop(vec[m]<span class="op">,</span> s<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">end</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                <span class="kw">end</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">end</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># calculate the number of eggs to produce</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>            eggs <span class="op">=</span> q <span class="op">*</span> GetPop(vec[<span class="fl">5</span>]) <span class="op">*</span> exp(<span class="op">-</span>GetPop(vec[<span class="fl">5</span>])<span class="op">/</span>A0)<span class="op">/</span>tau</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> stoch</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                eggs <span class="op">=</span> rand(Poisson(eggs))</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">end</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            AddPop(vec[<span class="fl">1</span>]<span class="op">,</span> eggs)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># record the current state</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>            output[n<span class="op">+</span><span class="fl">1</span><span class="op">,</span> <span class="op">:</span>] <span class="op">=</span> [GetPop(v) <span class="kw">for</span> v <span class="kw">in</span> vec]</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return the results</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> output</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span></code></pre></div>
<p>We run the deterministic model, and sample 100 trajectories from the stochastic model. We plot results from the last 200 days of simulation.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> sim_blowfly(<span class="ex">false</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    xtick <span class="op">=</span> <span class="fl">100</span><span class="op">:</span>(<span class="fl">1</span><span class="op">/</span>tau)<span class="op">:</span><span class="fl">300</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    plot(xtick<span class="op">,</span> out[<span class="fl">100</span><span class="op">*</span>tau<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="kw">end</span><span class="op">,</span><span class="fl">5</span>]<span class="op">,</span> label <span class="op">=</span> <span class="st">&quot;Adults&quot;</span><span class="op">,</span> color <span class="op">=</span> <span class="op">:</span>blue<span class="op">,</span> ylim <span class="op">=</span> [<span class="fl">0</span><span class="op">,</span><span class="fl">6000</span>])</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    plot<span class="op">!</span>(xtick<span class="op">,</span> out[<span class="fl">100</span><span class="op">*</span>tau<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="kw">end</span><span class="op">,</span><span class="fl">1</span>]<span class="op">,</span> label <span class="op">=</span> <span class="st">&quot;Eggs&quot;</span><span class="op">,</span> color <span class="op">=</span> <span class="op">:</span>red)</span></code></pre></div>
<figure>
<img src="figures/blowfly_figure1.png" alt="Deterministic dynamics" /><figcaption aria-hidden="true">Deterministic dynamics</figcaption>
</figure>
<div class="sourceCode" id="cb18"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>    outs <span class="op">=</span> [sim_blowfly(<span class="ex">true</span>) <span class="kw">for</span> n <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    outs <span class="op">=</span> cat(outs<span class="op">...,</span> dims<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    outs_adult_qt <span class="op">=</span> [quantile(outs[i<span class="op">,</span><span class="fl">5</span><span class="op">,:</span>]<span class="op">,</span> [<span class="fl">0.025</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.975</span>]) <span class="kw">for</span> i <span class="kw">in</span> axes(outs<span class="op">,</span><span class="fl">1</span>)]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    outs_adult_qt <span class="op">=</span> transpose(hcat(outs_adult_qt<span class="op">...</span>))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    outs_eggs_qt <span class="op">=</span> [quantile(outs[i<span class="op">,</span><span class="fl">1</span><span class="op">,:</span>]<span class="op">,</span> [<span class="fl">0.025</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.975</span>]) <span class="kw">for</span> i <span class="kw">in</span> axes(outs<span class="op">,</span><span class="fl">1</span>)]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    outs_eggs_qt <span class="op">=</span> transpose(hcat(outs_eggs_qt<span class="op">...</span>))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    xtick <span class="op">=</span> (<span class="fl">0</span><span class="op">:</span>(size(outs_adult_qt)[<span class="fl">1</span>]<span class="op">-</span><span class="fl">1</span>))<span class="op">/</span><span class="fl">24.0</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    plot(xtick<span class="op">,</span> outs_adult_qt[<span class="op">:,</span><span class="fl">3</span>]<span class="op">,</span> color<span class="op">=</span><span class="st">&quot;#0571b0&quot;</span><span class="op">,</span> fillrange<span class="op">=</span>outs_adult_qt[<span class="op">:,</span><span class="fl">1</span>]<span class="op">,</span> lw<span class="op">=</span><span class="fl">1</span><span class="op">,</span> alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">,</span> label<span class="op">=:</span>none)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    plot<span class="op">!</span>(xtick<span class="op">,</span> outs_adult_qt[<span class="op">:,</span><span class="fl">2</span>]<span class="op">,</span> color<span class="op">=</span><span class="st">&quot;#0571b0&quot;</span><span class="op">,</span> lw<span class="op">=</span><span class="fl">2</span><span class="op">,</span> label<span class="op">=:</span>none)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    plot<span class="op">!</span>(xtick<span class="op">,</span> outs_eggs_qt[<span class="op">:,</span><span class="fl">3</span>]<span class="op">,</span> color<span class="op">=</span><span class="st">&quot;#d6604d&quot;</span><span class="op">,</span> fillrange<span class="op">=</span>outs_eggs_qt[<span class="op">:,</span><span class="fl">1</span>]<span class="op">,</span> lw<span class="op">=</span><span class="fl">1</span><span class="op">,</span> alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">,</span> label<span class="op">=:</span>none)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    plot<span class="op">!</span>(xtick<span class="op">,</span> outs_eggs_qt[<span class="op">:,</span><span class="fl">2</span>]<span class="op">,</span> color<span class="op">=</span><span class="st">&quot;#d6604d&quot;</span><span class="op">,</span> lw<span class="op">=</span><span class="fl">2</span><span class="op">,</span> label<span class="op">=:</span>none)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    xlims<span class="op">!</span>(<span class="fl">100</span><span class="op">,</span><span class="fl">300</span>)</span></code></pre></div>
<figure>
<img src="figures/blowfly_figure2.png" alt="Stochastic dynamics" /><figcaption aria-hidden="true">Stochastic dynamics</figcaption>
</figure>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
